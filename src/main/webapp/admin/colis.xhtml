<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml"
      xmlns:h="http://xmlns.jcp.org/jsf/html"
      xmlns:f="http://java.sun.com/jsf/core"
      xmlns:ui="http://xmlns.jcp.org/jsf/facelets">

<h:head>
    <title>Gestion des Colis - Admin Dashboard</title>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdn.jsdelivr.net/npm/remixicon@3.5.0/fonts/remixicon.css" rel="stylesheet" />
    <style>
        /* Cache les modals externes par défaut */
        .modal-overlay {
            display: none;
            position: fixed;
            inset: 0;
            background-color: rgba(0, 0, 0, 0.5);
            z-index: 50;
            align-items: center;
            justify-content: center;
        }
        .modal-overlay.show {
            display: flex !important;
        }
    </style>
</h:head>

<h:body class="bg-gray-50 font-sans">

    <!-- Sidebar -->
    <aside class="w-64 h-screen bg-white border-r border-gray-200 fixed top-0 left-0 flex flex-col">
        <!-- Logo -->
        <div class="px-6 py-5 border-b border-gray-200">
            <h1 class="text-xl font-semibold text-blue-600">Espace Admin</h1>
        </div>

        <!-- Navigation -->
        <nav class="flex-1 px-4 py-6 space-y-1">
            <h:link outcome="admin-dashboard"
                    styleClass="flex items-center px-4 py-2.5 text-gray-700 hover:bg-gray-50 rounded-lg transition group">
                <i class="ri-dashboard-line text-xl mr-3 text-gray-400 group-hover:text-blue-600"></i>
                <span class="text-sm font-medium">Tableau de bord</span>
            </h:link>

            <h:link outcome="colis"
                    styleClass="flex items-center px-4 py-2.5 bg-blue-50 text-blue-600 rounded-lg">
                <i class="ri-box-3-line text-xl mr-3"></i>
                <span class="text-sm font-medium">Mes colis</span>
            </h:link>

            <h:link outcome="admin-livreurs"
                    styleClass="flex items-center px-4 py-2.5 text-gray-700 hover:bg-gray-50 rounded-lg transition group">
                <i class="ri-user-star-line text-xl mr-3 text-gray-400 group-hover:text-blue-600"></i>
                <span class="text-sm font-medium">Livreurs</span>
            </h:link>

            <h:link outcome="admin-clients"
                    styleClass="flex items-center px-4 py-2.5 text-gray-700 hover:bg-gray-50 rounded-lg transition group">
                <i class="ri-group-line text-xl mr-3 text-gray-400 group-hover:text-blue-600"></i>
                <span class="text-sm font-medium">Clients</span>
            </h:link>

            <h:link outcome="historique"
                    styleClass="flex items-center px-4 py-2.5 text-gray-700 hover:bg-gray-50 rounded-lg transition group">
                <i class="ri-time-line text-xl mr-3 text-gray-400 group-hover:text-blue-600"></i>
                <span class="text-sm font-medium">Historique</span>
            </h:link>
        </nav>

        <!-- Profil admin -->
        <div class="border-t border-gray-200 p-4">
            <div class="bg-gray-50 rounded-lg p-4">
                <div class="flex items-center mb-3">
                    <div class="bg-blue-100 rounded-full w-10 h-10 flex items-center justify-center mr-3">
                        <i class="ri-user-line text-blue-600 text-xl"></i>
                    </div>
                    <div class="flex-1 min-w-0">
                        <p class="text-sm font-semibold text-gray-800 truncate">Admin User</p>
                        <p class="text-xs text-gray-500">Administrateur</p>
                    </div>
                </div>

                <div class="space-y-2">
                    <div class="flex items-center text-xs text-gray-600">
                        <i class="ri-mail-line mr-2"></i>
                        <span class="truncate">admin@example.com</span>
                    </div>
                </div>

                <h:link outcome="profil" styleClass="w-full mt-3 flex items-center justify-center px-3 py-2 text-sm text-blue-600 hover:bg-blue-50 rounded-lg transition">
                    <i class="ri-user-settings-line mr-2"></i>
                    Mon profil
                </h:link>

                <h:form styleClass="mt-2">
                    <h:commandLink action="#{loginBean.logout}" styleClass="w-full flex items-center justify-center px-3 py-2 text-sm text-red-600 hover:bg-red-50 rounded-lg transition">
                        <i class="ri-logout-box-line mr-2"></i>
                        Déconnexion
                    </h:commandLink>
                </h:form>
            </div>
        </div>
    </aside>

    <!-- Contenu principal -->
    <main class="ml-64 p-8">

        <!-- Header -->
        <header class="mb-6">
            <div class="flex justify-between items-center mb-4">
                <div>
                    <h1 class="text-2xl font-semibold text-gray-800">Gestion des Colis</h1>
                    <p class="text-sm text-gray-500 mt-1">Gérez tous les colis de votre plateforme</p>
                </div>
                <button type="button" id="open-modal-btn" class="bg-blue-600 text-white px-4 py-2.5 rounded-lg hover:bg-blue-700 transition flex items-center text-sm font-medium">
                    <i class="ri-add-line mr-2"></i> Ajouter un colis
                </button>
            </div>

            <!-- Message de bienvenue -->
            <div class="bg-emerald-50 border-l-4 border-emerald-400 p-4 rounded flex items-start">
                <i class="ri-checkbox-circle-line text-emerald-500 text-xl mr-3 mt-0.5"></i>
                <p class="text-emerald-800 text-sm">Bienvenue dans votre tableau de bord, Admin !</p>
            </div>
        </header>

        <!-- Card principale -->
        <div class="bg-white rounded-lg border border-gray-200">

            <!-- Tableau des colis -->
            <div class="p-6">
                <h:form id="dataTableForm">
                    <div class="overflow-x-auto">
                        <table class="w-full">
                            <thead>
                            <tr class="border-b border-gray-200">
                                <th class="text-left py-3 px-4 text-sm font-medium text-gray-600">Référence</th>
                                <th class="text-left py-3 px-4 text-sm font-medium text-gray-600">Client</th>
                                <th class="text-left py-3 px-4 text-sm font-medium text-gray-600">Destination</th>
                                <th class="text-left py-3 px-4 text-sm font-medium text-gray-600">Statut</th>
                                <th class="text-left py-3 px-4 text-sm font-medium text-gray-600">Date création</th>
                                <th class="text-left py-3 px-4 text-sm font-medium text-gray-600">Actions</th>
                            </tr>
                            </thead>
                            <tbody>
                            <ui:repeat value="#{colisBean.listeColis}" var="colis">
                                <tr class="border-b border-gray-100 hover:bg-gray-50">
                                    <!-- Référence -->
                                    <td class="py-3 px-4 text-sm text-gray-800 font-mono">
                                        <h:outputText value="#{colis.numeroSuivi}" />
                                    </td>

                                    <!-- Client -->
                                    <td class="py-3 px-4 text-sm text-gray-800">
                                        <h:outputText value="#{colis.utilisateur.nom} #{colis.utilisateur.prenom}" />
                                    </td>

                                    <!-- Destination -->
                                    <td class="py-3 px-4 text-sm text-gray-600">
                                        <h:outputText value="#{colis.adresseDestinataire.ville}, #{colis.adresseDestinataire.pays}" />
                                    </td>

                                    <!-- Statut -->
                                    <td class="py-3 px-4">
                                        <h:outputText value="Livré"
                                                      styleClass="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-emerald-100 text-emerald-800"
                                                      rendered="#{colis.status.toString() eq 'LIVRE'}" />
                                        <h:outputText value="En transit"
                                                      styleClass="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-amber-100 text-amber-800"
                                                      rendered="#{colis.status.toString() eq 'EN_TRANSIT'}" />
                                        <h:outputText value="En attente"
                                                      styleClass="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-blue-100 text-blue-800"
                                                      rendered="#{colis.status.toString() eq 'EN_ATTENTE'}" />
                                        <h:outputText value="Retourné"
                                                      styleClass="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-orange-100 text-orange-800"
                                                      rendered="#{colis.status.toString() eq 'RETOURNE'}" />
                                        <h:outputText value="Annulé"
                                                      styleClass="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-red-100 text-red-800"
                                                      rendered="#{colis.status.toString() eq 'ANNULE'}" />
                                    </td>

                                    <!-- Date -->
                                    <td class="py-3 px-4 text-sm text-gray-600">
                                        <h:outputText value="#{colisBean.formatDate(colis.dateEnvoi)}" />
                                    </td>

                                    <!-- Actions -->
                                    <td class="py-3 px-4">
                                        <div class="flex items-center space-x-2">
                                            <!-- Voir -->
                                            <h:commandButton value="Voir"
                                                             styleClass="text-blue-600 hover:text-blue-700 text-xs font-medium px-2 py-1 hover:bg-blue-50 rounded transition">
                                                <f:ajax execute="@this" render=":detailsModal"
                                                        listener="#{colisBean.chargerColisAModifier(colis)}"
                                                        onevent="function(data){ if(data.status==='success'){ document.getElementById('details-modal-overlay').classList.add('show'); } }" />
                                            </h:commandButton>

                                            <!-- Modifier -->
                                            <h:commandButton value="Modifier"
                                                             styleClass="text-gray-600 hover:text-gray-700 text-xs font-medium px-2 py-1 hover:bg-gray-50 rounded transition">
                                                <f:ajax render=":editForm"
                                                        listener="#{colisBean.chargerColisAModifierA(colis)}"
                                                        onevent="function(data){ if(data.status==='success'){ document.getElementById('edit-modal-overlay').classList.add('show'); } }" />
                                            </h:commandButton>

                                            <!-- Bordereau PDF -->
                                            <h:commandButton value="PDF"
                                                             styleClass="text-teal-600 hover:text-teal-700 text-xs font-medium px-2 py-1 hover:bg-teal-50 rounded transition"
                                                             title="Générer bordereau d'expédition"
                                                             action="#{mesColisBean.genererBordereauPDF(colis.id)}"
                                                             immediate="true" />

                                            <!-- Supprimer -->
                                            <h:commandButton value="Supprimer"
                                                             action="#{colisBean.supprimerColis}"
                                                             onclick="return confirm('Êtes-vous sûr de vouloir supprimer ce colis?');"
                                                             styleClass="text-red-600 hover:text-red-700 text-xs font-medium px-2 py-1 hover:bg-red-50 rounded transition">
                                                <f:setPropertyActionListener target="#{colisBean.colisId}" value="#{colis.id}" />
                                            </h:commandButton>
                                        </div>
                                    </td>
                                </tr>
                            </ui:repeat>
                            </tbody>
                        </table>
                    </div>

                    <!-- Pagination -->
                    <div class="mt-6 flex justify-center">
                        <ui:include src="/WEB-INF/includes/pagination.xhtml" />
                    </div>
                </h:form>
            </div>
        </div>

    </main>

    <!-- Formulaires et Modals (gardés séparés car ils existent déjà) -->
    <ui:include src="/WEB-INF/components/colis-form.xhtml" />
    <ui:include src="/WEB-INF/components/edit-colis-form.xhtml" />
    <ui:include src="/WEB-INF/components/details-colis.xhtml" />

    <!-- Script pour ouvrir le modal d'ajout -->
    <script>
        // Attendre que la page soit chargée
        document.addEventListener('DOMContentLoaded', function() {
            // Bouton pour ouvrir le modal d'ajout
            const openBtn = document.getElementById('open-modal-btn');
            if (openBtn) {
                openBtn.addEventListener('click', function() {
                    // Chercher l'overlay du modal d'ajout (adapté selon votre structure)
                    const addModal = document.querySelector('[id*="add-modal"], [id*="addForm"], [id*="colis-form"]');
                    if (addModal) {
                        addModal.classList.add('show');
                        addModal.style.display = 'flex';
                    } else {
                        // Si pas trouvé, essayer avec un ID spécifique
                        const modal = document.getElementById('add-modal-overlay');
                        if (modal) {
                            modal.classList.add('show');
                            modal.style.display = 'flex';
                        }
                    }
                });
            }
        });
    </script>

</h:body>
</html>